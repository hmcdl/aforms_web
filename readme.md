# AFORMS Web

A-FORMS Web - это многопользовательский сервис для использования системы анализа и оптимизации авиационных конструкций AFORMS.

Сервис позволяет заводить клиентские аккаунты, загружать в аккаунт проекты (модели самолетов в формате mdl), проводить расчеты и оптимизацию проектов, получая в режиме реального времени данные о ходе работы алгоритма (при работе в клиентском приложении), загружать обратно на локальный компьютер архив с данными о результатах работы алгоритма над проектом. 

TODO:
1. Полноценная админка 
2. Распределение нагрузки на другие сервера.

## Установка и развертывание

Для работы сервиса необходимо наличие установленной субд PostgresQL, решателя FEMAP Nastran.

Для установки из репозитория:

1. Клонируете репозиторий
```bash
git clone -b master https://github.com/hmcdl/aformes_web.git
```

2. Создаете виртуальное окружение для Python версии >=3.10. [дока](https://docs.python.org/3/library/venv.html "документация по venv")
```bash
<path/to/python.exe> -m venv venv
```
<path/to/python.exe> - путь к интерпретатору (по дефолту "c:\Users\Mikhail\AppData\Local\Programs\Python\Python3X\python.exe" где Х - версия Питона), venv - модуль для создания виртуального окружения, аргумент venv создает папку "venv"

Активируем (Windows):
```bash
.\venv\Scripts\activate
```
3. установка зависимостей
```bash
pip install -r requirements.txt
```
4. Создаем базу данных. Создание базы с пустыми таблицами производится из .sql файла в корне репозитория. Один из способов это сделать:
Открываем pgAdmin. Создаем сервер. В сервере создаем БД. В бд заходим в query tools, туда вставляем содержимое .sql файла и воспроизводим.
5. Установка своих локальных и секретных данных в файл .env
 В корне есть файл .env.example, в нем пример данных, которые надо задать, чтобы они были актуальны для сервера.

Готово, осталось только запустить. 
 - Запуск с консоли. В той же директории:
```bash
uvicorn app.main:app
```
 - Запуск из-под студии в режиме дебага. Конфигурация дебага - debug current file (не fastAPI appication!). Содаем launch.json:
```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": "Python Debugger: Current File",
            "type": "debugpy",
            "request": "launch",
            "program": "${file}",
            "console": "integratedTerminal",
            "env": { "PYTHONPATH": "${workspaceRoot}"}
        }
    ]
}
```
*В данный момент сервер не работает с опцией --reload. Связано это с особенностями взаимодействия с циклом событий в Windows. При добавлении аргумента reload=True в режиме дебага или --reload при запуске uvicorn app.main:app сервер будет падать в момент запуска расчета.*
 

## Использование
Документация в браузере (работает только когда сервер включен): 
http://127.0.0.1:8000/docs 

Для работы с функционалом нужен аккаунт. Заводится через эндпойнт /users/Create User. 
Создание новых пользователей пока только через автодок (/users/Create User)
Для работы с расчетами - раздел /simulations/
- Создание проекта - add_simulation - даем расчету уникальное имя и загружаем требуемые файлы. 
- удаление проекта- remove_sim - удаляет по названию проекта
- show_my_sims - выводит список проектов с указанием, завершен/не завершен расчет
- start_simulation - запуск расчета проекта по его имени. Расчет может продолжаться существенное время, в автодоке будет тупо крутиться бегунок
- download - загрузка архива с данными по проекту. Можно использовать как до, так и после запуска расчета.

Использование приложения совместно с [aforms_web_client](https://github.com/hmcdl/aformes_web_client "клиент для АПИ")

